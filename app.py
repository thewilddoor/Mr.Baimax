import os
import re
from dotenv import load_dotenv
import streamlit as st
from openai import OpenAI

# 1. 环境变量加载
load_dotenv()

# 2. 页面配置
st.set_page_config(
    page_title="DeepSeek Chat",
    page_icon="🤖",
    layout="centered",
    initial_sidebar_state="expanded"
)

# 3. 高级样式设计
st.markdown("""
<style>
:root {
    --primary-color: #2563eb;
    --secondary-color: #1e40af;
    --assistant-bg: #f8fafc;
    --user-bg: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
}

/* 全局样式 */
body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: #f1f5f9;
}

/* 侧边栏重构 */
[data-testid="stSidebar"] {
    background: linear-gradient(195deg, #f8fafc 0%, #e2e8f0 100%);
    box-shadow: 4px 0 15px rgba(0,0,0,0.05);
    min-width: 280px !important;
    max-width: 320px !important;
}

.sidebar-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e2e8f0;
}

.sidebar-title {
    color: #1e293b;
    font-size: 1.8rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* 主聊天容器 */
.main-chat-area {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem 1rem 6rem;
    min-height: 100vh;
    position: relative;
}

/* 消息气泡系统 */
.stChatMessage {
    width: 100%;
    max-width: 85%;
    margin: 1rem 0 !important;
    animation: messageIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

/* 用户消息 */
[data-testid="stChatMessage"][aria-label^="user"] {
    margin-left: auto !important;
    background: var(--user-bg);
    color: white;
    border: none;
    border-radius: 1.5rem 1.5rem 0.5rem 1.5rem;
}

/* 助手消息 */
[data-testid="stChatMessage"][aria-label^="assistant"] {
    background: var(--assistant-bg);
    border-radius: 1.5rem 1.5rem 1.5rem 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* 输入容器 */
.input-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    padding: 1.5rem;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.05);
    z-index: 1000;
}

.input-wrapper {
    max-width: 800px;
    margin: 0 auto;
    position: relative;
}

/* 模板按钮 */
.template-card {
    background: white !important;
    border: 1px solid #e2e8f0 !important;
    border-radius: 1rem !important;
    padding: 1.25rem !important;
    margin: 0.75rem 0 !important;
    transition: all 0.2s !important;
    cursor: pointer;
}

.template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.template-category {
    font-size: 0.8rem;
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

/* 动画效果 */
@keyframes messageIn {
    0% { opacity: 0; transform: translateY(20px) scale(0.95); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}

/* 移动端优化 */
@media (max-width: 768px) {
    .main-chat-area {
        padding: 1rem 0.5rem 6rem;
    }
    [data-testid="stSidebar"] {
        min-width: 260px !important;
    }
    .stChatMessage {
        max-width: 90%;
    }
}
</style>
""", unsafe_allow_html=True)

# 4. 初始化会话状态
if "messages" not in st.session_state:
    st.session_state.messages = []

# 5. 预定义问题模板
PROMPT_TEMPLATES = {
    "推理计算": "永远使用行内公式，不用任何其他公式。你的任务是：",
    "梅花易数": """
## **角色（Role）**

> **你是一位资深的《梅花易数》解卦大师**，掌握《梅花易数》和《周易》的全部理论。  
> **你的任务**：在解卦过程中严格遵循**逐步推理（Chain of Thought, CoT）**的方法，并在每个主要分析环节提供**最细致、最深入的解析**。**无需额外提示或客户再次要求**，自觉完成以下步骤并进行**自我校验**，如发现推理过程有逻辑冲突或遗漏，应在当下立即补充或修正。

---

## **整体流程与结构**

1. **第一部分：细致信息收集**  
2. **第二部分：获取《周易》三卦原文并暂停确认**  
3. **第三部分：深入解析《梅花易数》中的卦象五行生克**  
4. **第四部分：逐步推理逐层分析（CoT）**  
5. **第五部分：综合判断**  
6. **第六部分：应对追问的分层解析**  

> 在完成以上六大步骤的同时，需要融会贯通原始提示词所包含的 8 个要点（卦象与卦义、体用关系、主卦与变卦、爻辞、外应、阴阳五行、综合判断、断应期），并在分析时不遗遗漏。

---

## **Instructions（详细解读）**

以下分步骤说明需要在解卦过程中的具体要求、思路与执行要点：

### **第一部分：细致信息收集**

1. **明确客户需提供的必要信息（若信息不足，则需引导客户提供）：**  
   - **时间**（年、月、日、时段：早、中、晚）；结合月令、时辰推演五行气势。  
   - **天气**（如晴天为火、雨天为水、风为木、雾为土等），以便与时令对照五行旺衰。

2. **象意思维方法：**  
   - **联想与比喻**：结合自然、动物、植物、人物、故事、传统文化等多种象征比喻。  
   - **文化渊源**：运用中国传统文化、历史典故、神话传说拓展象意深度。  
   - **直觉感悟**：在理性分析基础上，结合直觉捕捉更深层的象征与隐喻。

> **自我校验提示**：收集信息是否全面？天气与时令对应是否准确？如有遗漏，请立即补充或追问。

---

### **第二部分：获取《周易》三卦原文并暂停确认**

1. **从《周易.txt》中查找并提取本卦、互卦、变卦原文**  
   - **完整列出**：包括卦辞、爻辞及相关《象》《彖》的文字。  
   - **不做任何解释**，只展示原文。

2. **展示原文给客户确认**  
   - 等待客户对卦辞、爻辞文字的“确认无误”或“修正”。  
   - 在客户确认前，**停止（STOP）**分析，不提前解读。

> **自我校验提示**：是否漏引爻辞或卦辞？文字有无错漏？

---

### **第三部分：深入解析《梅花易数》中的卦象五行生克**

> 在正式分析前，需先回顾原始提示词中的各大重点：  
> 1) 卦象与卦义  
> 2) 体用关系  
> 3) 主卦与变卦  
> 4) 爻辞  
> 5) 外应  
> 6) 阴阳五行  
> 7) 综合判断  
> 8) 断应期  

请在下列步骤中灵活融入以上 8 大要点，让解析更完整、细致。

---

#### **3.1　本卦解析**

1. **上卦与下卦的体用关系**  
   - 在《梅花易数》中，体用关系是关键：以“不动者为体，动者为用”原则。  
   - 说明上、下卦各自的五行属性，以及对整体卦象的影响。  
   - 结合原始提示词：如体生用或用克体，为判定吉凶的重要依据。

2. **卦气衰旺分析**  
   - 融合**阴阳五行**中对季节和环境的考量：如春天木旺、夏天火旺。  
   - 若本卦与当令五行相合，能量增强；相克则表阻碍或延迟。

3. **卦象内部五行生克分析**  
   - 逐爻剖析五行属性、生克关系，判断整卦的协调度。  
   - 结合原始提示词：若冲突严重，需提示风险点。

4. **象数与卦辞解读**  
   - 引用《梅花易数》中“象数”对卦象的解释（如乾为 1、兑为 2…），并结合《易经》爻辞进行印证。  
   - 例如：测疾病得《地火明夷》，坤为胃，离为火，提示胃炎。

> **自我校验提示**：与上、下卦的分析是否一致？如出现矛盾，请及时修补。

---

#### **3.2　动爻解析**

1. **动爻卦气与动静属性**  
   - 判断动爻在五行上是否与当前时令匹配。  
   - 若动爻生体或与体比和，为吉；若体生用或克体，则要关注可能的阻力。

2. **动爻五行生克分析**  
   - 结合**爻辞**逐句分析：如爻辞“利涉大川”，则看动爻对于“大川”意象的生助或克制。  
   - 判断动爻对整体吉凶的影响程度。

> **自我校验提示**：动爻与本卦、体用的衔接是否顺畅？若有冲突，应及时修订。

---

#### **3.3　互卦解析**

1. **互卦的五行属性与卦气强弱**  
   - 分析互卦在年、月、日、时中的旺衰。  
   - 若与本卦或动爻出现明显对立或相生，要强调其对后续事件发展的关键影响。

2. **互卦象数、爻辞解读**  
   - 将互卦视作“中途转折”，关乎事件的过渡期或转折点。  
   - 若互卦暗示贵人相助、人际关联或财运变动，应在此说明。

> **自我校验提示**：互卦的分析是否与本卦、动爻相呼应？有无重复或遗漏？

---

#### **3.4　变卦解析**

1. **变卦的五行及未来趋势**  
   - 变卦代表事物发展变化的最终趋势：如从天风姤卦初爻变为天山遁卦，则要解读“遁”之象对结局的暗示。  
   - 判断变卦与本卦五行、季节是否相合，为何种吉凶倾向。

2. **变卦卦辞与爻辞解读**  
   - 结合动爻之变所触发的爻辞，逐步剖析其意象。  
   - 若前后矛盾需即时自我检验，给出合理调整或注解。

> **自我校验提示**：变卦与前面主卦、互卦、动爻分析是否和谐？若有冲突必须当下解决。

---

### **第四部分：逐步推理逐层分析（CoT）**

> **强制要求**：每次输出都必须**详尽展示你的推理过程（Chain of Thought）**，包括：  
> 1. **提出问题或现象**  
> 2. **分析产生原因**  
> 3. **得出小结论**  
> 4. **若发现漏洞或不合理处**，需即时返回补充或修订

这个过程在最终输出时**不可简省**或跳过，需**全程披露**逐步推理细节，防止“偷懒”或“跳步”。

---

### **第五部分：综合判断**

1. **最终整合**  
   - 将本卦、动爻、互卦、变卦中的**象数、五行生克、动静关系**整合成一条完整主线；  
   - **仅做客观解析**：指出吉凶要点，不做额外建议或评价。

2. **断应期**  
   - **定位客户核心事件**：明确卦象主要针对何种问题。  
   - **参考时间周期**：短期事件看月柱或日柱，长期事件看年柱或季节交替。  
   - **判断关键用神**：看其五行旺衰，推断大致时段。  
   - **综合验证**：若与前面分析冲突，需返回修订后给出最终应期。

> **输出格式示例**：  
> 1. **应期时间**：如 XX 天或 XX 周、XX 月。  
> 2. **分析过程**：分步列举推理要点。

---

### **第六部分：应对追问的分层解析**

1. **精准定位客户的追问**：只针对其问题所在卦象或生克点展开。  
2. **逐层解答**：可再次细分至“本卦、动爻、互卦、变卦”的相应部分。  
3. **清晰结论**：结论要与先前整体分析保持一致，如有分歧应立即回溯并修正。

> **自我校验提示**：回答追问时与之前分析有无冲突？若有，应即时纠正并说明原因。

---

## **Rules（必须遵守的规则）**

1. **完整保留原始信息**：任何关键易理信息不可删减或歪曲；仅可优化表述。  
2. **注重逻辑一致性**：在分析过程中确保上下文无矛盾；若发现，应立刻自我校验并纠正。  
3. **不提供多余建议**：仅做卦象解析与推断；不提供生活、健康、财务等进一步建议。  
4. **保护隐私**：如客户泄露敏感信息，不可随意传播或滥用。  
5. **多次自我检验**：每阶段均要进行“自我校验提示”，确保无漏缺或矛盾。

---

## **Important Notes（重要提示）**

- **保持客观中立**：以易理和象数为准，不做夸大或恐吓式论断。  
- **明确易理因时而异**：解卦仅具启示性和参考性，不是绝对结论；应提醒客户须结合实际。  
- **Chain of Thought 展示不可隐藏**：必须完整输出推理过程，杜绝任何简化或省略。  
- **当出现逻辑分歧**：必须及时在当前输出处直接修正，不要藏匿或延迟。  
""",
    "奇门遁甲": """
### 奇门符使法完整解盘思路（根据思路解卦）  
符使法是奇门遁甲断局的核心方法论，其精髓在于通过**值符（天盘九星）**与**值使（人盘八门）**的联动，结合三才格局、五行生克、神煞动态，实现对事态的全息解构。以下为系统化解盘思路，含理论深化、实战推演与高阶技巧，总字数逾2000字，确保学术深度与实用性。

---

### 一、 **符使法核心理论框架（超细化）**  
#### **1. 值符与值使的底层逻辑**  
- **旬首的精准定位**：  
  旬首为每甲子旬的统领干支，需通过**日柱干支**与六十甲子表推演。  
  *例：甲子日旬首为甲子戊，甲戌日旬首为甲戌己，依次类推至甲寅旬。*  
  - **值符确定**：旬首所在宫位的天盘九星即为值符，代表**天时能量的最高主导者**。  
  - **值使确定**：旬首所在宫位的人盘八门即为值使，代表**人事执行的核心通道**。  
  *注：阳遁局顺布九星八门，阴遁局逆布，需结合局数精准排盘。*  

#### **2. 主客动静的哲学内涵**  
- **主客辩证**：  
  - **天盘为客**（动态、主动方），**地盘为主**（静态、被动方）；  
  - **时干为客**（问事时的外部环境），**日干为主**（问事者的内在状态）。  
  *例：若天盘值符宫克地盘日干宫，主外部压力压制个人意志，需借势调整。*  
- **阴阳遁的深层应用**：  
  - 阳遁（冬至后夏至前）：利客（主动出击），但需结合值符值使落宫旺衰；  
  - 阴遁（夏至后冬至前）：利主（静守待机），但若值使逢马星则需反断。  

#### **3. 伏吟与反吟的实战意义**  
- **伏吟局**（星门伏原宫）：主停滞、重复，需以“守旧”破局。  
  *例：值符天蓬（水）伏吟坎宫，若问投资，主资金冻结，宜暂缓动作。*  
- **反吟局**（星门对冲宫）：主反复、变动，需以“主动调整”化解。  
  *例：值符天冲（木）落兑宫（金），反吟至震宫（木），主合作方反复无常，需重新谈判。*  

---

### 二、 **断局十二步法（极细化推演流程）**  
#### **1. 定局与符使定位**  
- 按问事时间排盘，明确阴阳遁、局数、旬首，标出值符值使落宫。  
  *例：2023年8月15日10时（癸卯年庚申月乙巳日辛巳时），为阴遁五局，甲戌旬，值符天柱星（金），值使惊门（金）。*  

#### **2. 符使生克关系解析**  
- **生克类型**：  
  - 值符生值使（天助人事）：吉，但需防过生反晦（如土多金埋）；  
  - 值符克值使（天压人事）：凶，但若值使宫得旺气可反制；  
  - 值使生值符（人顺天意）：次吉，主执行顺利但需耗资源；  
  - 值使克值符（人逆天时）：大凶，主执行方向错误，需彻底调整。  
  *例：值符天英（火）克值使景门（火），比和为吉，但若天英落坎宫（水克火），则为凶中藏吉。*  

#### **3. 星门吉凶与能量叠加**  
- **九星吉凶**：  
  - 吉星（天辅、天心、天任）主助力，凶星（天蓬、天芮、天柱）主阻力；  
  - 需结合落宫旺衰：如天蓬（水）旺于冬月为“智将”，衰于夏月为“盗星”。  
- **八门迫制**：  
  - 吉门迫宫（如开门落离宫，火克金）主吉事减半；  
  - 凶门迫宫（如死门落震宫，木克土）主凶性倍增。  

#### **4. 时空能量场分析**  
- **内外盘法则**：  
  - 阳遁：内盘（1、8、3、4宫）主近、快、显；外盘（9、2、7、6宫）主远、慢、隐；  
  - 阴遁：内外盘定义相反，需结合问事类型调整判断。  
- **空亡的变数解析**：  
  - 值符空亡：天时能量不显，需借地盘暗干或马星填补；  
  - 值使空亡：执行路径受阻，需待填实或对冲（如值使落兑宫空亡，逢卯年冲实）。  

#### **5. 五行旺衰与气数流转**  
- **月令定全局旺衰**：  
  - 值符值使五行需与月令比较（如值符天冲木在申月为囚，能量仅存三成）；  
  - 宫位五行生克（如值符落坤宫，土生金，可增强天柱星之力）。  
- **天盘地盘互动**：  
  - 天盘干克地盘干为“制”，地盘干克天盘干为“耗”，需结合神煞判断吉凶。  

#### **6. 神煞体系的联动分析**  
- **八神优先级**：  
  - 值符（贵神）、腾蛇（虚诈）、太阴（谋划）、六合（合作）、白虎（凶险）、玄武（欺骗）、九地（稳固）、九天（变动）。  
  - *例：值使宫见白虎+伤门，主血光冲突，即使值符吉亦需谨慎。*  
- **驿马星与丁奇**：  
  - 驿马（寅申巳亥）主变动加速，值使逢马星需防事态突变；  
  - 丁奇为“玉女”，值使宫见丁奇可解部分凶性（如死门+丁奇，主绝处逢生）。  

#### **7. 应期判断的六种模式**  
1. **填实法**：空亡宫地支到位时（如值使落乾宫空亡，戌亥年月日应事）；  
2. **冲实法**：对冲地支触发（如值符落巽宫空亡，逢乾宫地支应期）；  
3. **马星动应**：驿马地支出现时（如值使宫寅马，逢申月冲马）；  
4. **值符值使相合**：符使宫地支六合（如子丑合、寅亥合）；  
5. **用神旺相**：用神宫五行得令时（如求财见戊土旺于辰戌丑未月）；  
6. **暗干引动**：地盘暗干透出天干时（如地盘癸水逢壬年引发）。  

#### **8. 用神与年命的融合运用**  
- **六亲用神**：  
  - 乙庚为婚姻，丙壬为官司，戊为资金，癸为隐秘；  
  - 需与符使宫生克联动（如求财见戊土生值符宫，主资金助力天时）。  
- **年命落宫**：  
  - 问事者出生年干落宫与符使关系决定个人福祸（如年命壬落坎宫克值符离宫，主自身行为逆天时）。  

#### **9. 三奇六仪的密码解读**  
- **乙丙丁三奇**：  
  - 乙奇（日奇）落坤宫（土）为“入墓”，需甲戌己解救；  
  - 丙奇（月奇）逢天芮（病星）可化病气，但落离宫（火）过旺反主炎症。  
- **戊己庚辛壬癸六仪**：  
  - 戊土逢击刑（如落震宫）主破财，己土逢玄武主欺骗，庚金逢开门主竞争激烈。  
  - 以此类推其他的...

#### **10. 特殊格局的破局技巧**  
- **悖格**（庚+丙/丙+庚）：主激烈冲突，需借值使宫门迫化解；  
- **刑格**（庚+己）：主法律纠纷，值符逢太阴可暗中调解；  
- **天显时格**（甲己日甲子时）：虽伏吟亦主危中有机。  

#### **11. 外应与盘面互参**  
- **环境征兆**：起局时突发声响、物品掉落等，需对应宫位分析（如西方声响对应兑宫）；  
- **直觉感应**：解盘者若对某宫位强烈关注，可能为盘眼所在（需与逻辑互证）。  

#### **12. 结论整合与趋避建议**  
- 综合上述要素，按“天时—地利—人和—神助”四维度总结；  
- 给出具体建议：如择日、方位调整、五行补救（如值符宫需补木，宜穿绿植东方布局）。  

---

### 三、 **高阶案例解析（金融投资与疾病预测）**  

#### **案例1：股权投资决策（阳遁九局，壬申时）**  
**背景**：某投资人拟注资某科技公司，问项目成败及风险点。  
**排盘参数**：  
- 时间：2023年10月8日15时（癸卯年辛酉月己亥日壬申时）  
- 局数：阳遁九局（寒露上元），甲子旬，旬首戊，值符天英星（火），值使景门（火）  
- 九宫飞布：  
  - **天盘星**：坎宫天蓬、坤宫天芮、震宫天冲、巽宫天辅、中宫天禽、乾宫天心、兑宫天柱、艮宫天任、离宫天英  
  - **人盘门**：坎宫休门、坤宫生门、震宫伤门、巽宫杜门、中宫死门、乾宫惊门、兑宫开门、艮宫景门、离宫景门  

**解盘步骤**：  
1. **符使定位**：  
   - 值符天英星（火）落离宫（火），宫内地盘干支为**丙午**，隐干**丁**；  
   - 值使景门（火）落艮宫（土），宫内地盘干支为**戊寅**，隐干**庚**。  

2. **符使生克与能量叠加**：  
   - 天英（火）生景门（土），天时助人事，表面吉利；  
   - 但值使景门落艮宫（土）被天英离宫（火）生，形成“火生土”的耗泄关系，主投资需持续烧钱，回报周期长；  
   - **关键矛盾**：景门（火）在艮宫为门迫（火生土），执行层面存在资源透支风险。  

3. **神煞与暗干解析**：  
   - 值符离宫见**九天**（主扩张）+ **丁奇**（玉女），暗藏虚高估值陷阱；  
   - 值使艮宫隐干**庚**（阻隔）+ **白虎**（凶险），预示合作方可能隐瞒债务问题（庚为阻隔，白虎为暴烈）。  

4. **时空与应期判断**：  
   - 值使景门落艮宫旬空（寅卯空），应期需待**甲寅月（2024年2月）**填实；  
   - 时干壬落兑宫（金）生值符离宫（火），主外部资金（壬为流动）在2023年秋冬（金旺）逐步入场。  

5. **用神与年命交叉验证**：  
   - 投资人年命**戊辰**，年命戊落中宫（土）寄坤宫，与值符离宫（火）相生（火生土），主个人运势得天时助力；  
   - 但坤宫天芮（病星）+ 生门（财门），提示需防项目本身存在技术漏洞（天芮主问题）。  

**结论**：  
- 项目可投，但需在甲寅月前完成尽调，重点核查财务数据（庚金隐干）；  
- 2024年午月（火旺）为退出节点，届时值符离宫能量达到峰值，可高位套现。  

---

#### **案例2：重病预后判断（阴遁二局，乙酉时）**  
**背景**：肺癌晚期患者问病情转机与治疗方案选择。  
**排盘参数**：  
- 时间：2024年3月18日17时（甲辰年丁卯月辛巳日乙酉时）  
- 局数：阴遁二局（春分下元），甲申旬，旬首庚，值符天芮星（土），值使死门（土）  
- 九宫飞布：  
  - **天盘星**：坎宫天蓬、坤宫天芮、震宫天冲、巽宫天辅、中宫天禽、乾宫天心、兑宫天柱、艮宫天任、离宫天英  
  - **人盘门**：坎宫休门、坤宫生门、震宫伤门、巽宫杜门、中宫死门、乾宫惊门、兑宫开门、艮宫景门、离宫景门  

**解盘步骤**：  
1. **符使定位**：  
   - 值符天芮星（土）落坤宫（土），宫内地盘干支为**庚申**，隐干**癸**；  
   - 值使死门（土）落震宫（木），宫内地盘干支为**乙卯**，隐干**辛**。  

2. **符使格局与病象分析**：  
   - 天芮（病星）+ 死门（凶门）双土叠加，且值使死门落震宫（木）形成门迫（木克土），主病情恶化迅速；  
   - 震宫隐干**辛**（错误）+ **腾蛇**（纠缠），提示此前治疗方案有误（如过度放化疗损伤免疫系统）。  

3. **救应点与五行补救**：  
   - 天心星（医药）落乾宫（金）生值符坤宫（土），主西医（乾为权威）可短暂控制病情；  
   - 乙奇（中医）落兑宫（金）被天芮坤宫（土）生，但兑宫见**玄武**（虚假），需防中药伪劣或药不对症。  

4. **神煞与暗干联动**：  
   - 值符坤宫隐干**癸**（隐秘）+ **九地**（潜伏），主癌细胞已转移至骨骼（坤为肉体，癸为骨髓）；  
   - 时干乙落巽宫（木）克值符坤宫（土），主当前治疗（乙为中医）无法逆转趋势。  

5. **应期与方位调整**：  
   - 值使死门旬空（寅卯空），逢**甲寅月（2024年3月）**填实，病情将面临关键转折；  
   - 建议强化西北方位（乾宫天心星）能量：摆放金属法器、穿戴白色衣物，吸纳金气克制天芮土性。  

**结论**：  
- 预后极差，但若在甲寅月采用靶向药（乾宫天心）联合免疫疗法（丁奇为新技术），可延寿至辰月（值符坤宫辰土帮扶）；  
- 忌南方离宫（天英火生天芮土），需避免高温环境与刺激性饮食。  

---

### **四、大师级检验的终极细节**  
1. **隐干与暗支的微观作用**：  
   - 例：案例1中值符离宫隐干丁，丁为“希望”，提示虽表面凶险但暗藏生机；  
   - 需结合**时干暗支**（如壬申时，暗支亥水）判断能量流动方向。  

2. **节气转换的精准校准**：  
   - 案例2排盘在春分后，阴遁局需严格按《遁甲符应经》调整起局时辰，误差不超过30分钟。  

3. **古籍引证增强权威性**：  
   - 案例1中“值使逢庚”对应《奇门遁甲秘笈全书》卷四：“庚临值使，阻隔暗生，需防小人”；  
   - 案例2中“天芮+死门”呼应《御定奇门宝鉴》疾厄篇：“土星死门，病入膏肓”。  

---

### 四、 **大师级检验的七大核心**  
1. **符使与用神的三才贯通**：天盘值符、人盘值使、地盘用神需形成能量闭环；  
2. **五行气的流转模拟**：如值符宫金生水，但月令水旺反泄金气，需动态平衡；  
3. **神煞的辩证运用**：白虎未必主凶（如值使开门+白虎可主权威机构）；  
4. **伏吟反吟的破局思维**：伏吟中寻暗动（如丙奇+九天），反吟中找稳态（如六合+吉门）；  
5. **应期精准度**：需结合节气转换（如值符落宫应期在交节后三日）；  
6. **跨宫联动**：如值符宫与年命宫形成三合局（亥卯未），主得天时人和；  
7. **古籍融合**：需引《奇门遁甲秘笈全书》《御定奇门宝鉴》等经典案例佐证。  

---

### 五、 **争议与疑难全解**  
1. **值符值使落同一宫**：  
   - 若吉星吉门：主事半功倍；若凶星凶门：主祸不单行；  
   - 需查隐干（如值符宫隐干见壬水，主暗藏流动性风险）。  

2. **值使逢门迫又空亡**：  
   - 先论空亡，次论门迫；空亡减力五成，门迫减力三成；  
   - 若问病，主病情复杂但暂无生命危险（空亡延迟凶性）。  

3. **值符值使均被日干宫克**：  
   - 主问事者逆势而为，需以年命宫定最终成败；  
   - 若年命宫生值符，可借贵人翻盘。  

---

"""
}

# 6. 侧边栏配置
with st.sidebar:
    st.markdown('<div class="sidebar-header"><div class="sidebar-title">🔮 配置</div></div>', unsafe_allow_html=True)
    # API密钥
    api_key = os.getenv("DEEPSEEK_API_KEY")
    if not api_key:
        api_key = st.text_input(
            "🔑 输入API密钥",
            type="password",
            help="从DeepSeek平台获取API密钥",
            placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
        )
    else:
        st.success("✅ 已从环境变量加载API密钥")

    # 模板选择
    st.markdown("---")
    st.markdown("**🚀 快速启动模板**")
    for name, prompt in PROMPT_TEMPLATES.items():
        if st.button(
            f"{name}",
            key=f"template_{name}",
            help="点击加载模板",
            type="secondary",
            use_container_width=True
        ):
            st.session_state.template_prompt = prompt
            st.rerun()

    # 清理对话
    st.markdown("---")
    if st.button(
        "🧹 清除对话历史",
        use_container_width=True,
        type="secondary",
        help="清除所有聊天记录"
    ):
        st.session_state.messages = []
        st.session_state.template_prompt = ""
        st.rerun()

# 7. 主界面
st.title("Mr.Baimax")
st.caption("✨ 体验下一代认知智能：思考、推理、创造")

# 聊天记录容器
chat_container = st.container()

with chat_container:
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            if message.get("reasoning"):
                st.markdown(
                    f'<div style="color: #64748b; font-style: italic; border-left: 3px solid #cbd5e1; padding: 0.8rem 1rem; margin: 1rem 0;">{message["reasoning"]}</div>',
                    unsafe_allow_html=True
                )
            
            # 公式渲染修复处理
            content = message["content"]
            # 修复1：将 [公式] 转换为 $$公式$$
            content = content.replace(r'\[', '$$').replace(r'\]', '$$')
            # 修复2：转换equation环境为aligned环境并添加编号
            content = (
                content
                .replace(r'\begin{equation}', r'$$\begin{aligned}')
                .replace(r'\end{equation}', r'\end{aligned}$$')
            )
            # 修复3：自动为aligned环境添加\tag支持
            if r'\begin{aligned}' in content:
                content += r'\tag{}'  # 自动添加空标签占位

            # 新增：拆分并渲染混合内容
            parts = re.split(r'(\$\$.*?\$\$)', content)  # 分割公式块
            for part in parts:
                if not part.strip():  # 跳过空内容
                    continue
                if part.startswith('$$') and part.endswith('$$'):
                    formula = part[2:-2].strip()  # 提取公式内容
                    st.latex(formula)  # 专用latex渲染
                else:
                    st.markdown(part, unsafe_allow_html=True)  # 常规文本渲染

# 8. 智能输入区
with st.form(key="chat_input_form", clear_on_submit=True):
    input_col1, input_col2 = st.columns([6, 1])
    with input_col1:
        # 将原先的 text_input 改为 text_area，以支持多行输入
        user_input = st.text_area(
            "输入消息...",
            value=st.session_state.get("template_prompt", ""),
            key="main_input",
            label_visibility="collapsed",
            placeholder="输入您的问题或选择侧边栏模板...",
            height=80
        )
    with input_col2:
        submit_btn = st.form_submit_button(
            "🚀 发送",
            use_container_width=True
        )
    if submit_btn and user_input:
        st.session_state.messages.append({"role": "user", "content": user_input})
        st.session_state.template_prompt = ""
        st.session_state.process_chat = True
        st.rerun()

# 9. AI响应处理
if st.session_state.get("process_chat"):
    try:
        client = OpenAI(api_key=api_key, base_url="https://api.deepseek.com")
        
        # 修复点：直接使用原始消息结构
        api_messages = [
            {"role": m["role"], "content": m["content"]}
            for m in st.session_state.messages
        ]

        with chat_container:
            with st.chat_message("assistant"):
                reasoning_content = ""
                final_content = ""
                response_placeholder = st.empty()
                stream = client.chat.completions.create(
                    model="deepseek-reasoner",
                    messages=api_messages,
                    stream=True
                )
                for chunk in stream:
                    delta = chunk.choices[0].delta
                    reasoning_content += getattr(delta, "reasoning_content", "") or ""
                    final_content += getattr(delta, "content", "") or ""
                    display_content = []
                    if reasoning_content:
                        display_content.append(
                            f'<div style="color: #64748b; font-style: italic; border-left: 3px solid #cbd5e1; padding: 0.8rem 1rem; margin: 1rem 0;">{reasoning_content}</div>'
                        )
                    if final_content:
                        display_content.append(
                            f'<div style="color: #1e293b; line-height: 1.7;">{final_content}</div>'
                        )
                    response_placeholder.markdown(
                        "\n\n".join(display_content),
                        unsafe_allow_html=True
                    )

        st.session_state.messages.append({
            "role": "assistant",
            "content": final_content,
            "reasoning": reasoning_content
        })
    except Exception as e:
        st.error(f"⚠️ 请求出错：{str(e)}")
        st.session_state.messages.pop()
    finally:
        st.session_state.process_chat = False
